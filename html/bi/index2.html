<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Intelligence</title>
    <link rel="stylesheet" href="business_intelligence.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <section id="business-intelligence">
        <h1>Business Intelligence</h1>

        <h2>Valores del Dólar en Colombia</h2>
        <table id="dollar-values">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Valor en Pesos Colombianos</th>
                    <th>Valor en Dólares</th>
                </tr>
            </thead>
            <tbody>
                <!-- Los datos se rellenarán aquí -->
            </tbody>
        </table>

        <h2>Estadísticas</h2>
        <label for="months">Ingrese el número de meses para el cálculo (máximo 12 meses):</label>
        <input type="number" id="months" name="months" value="3" min="1" max="12">
        <button onclick="generateStatistics()">Generar Estadísticas</button>

        <div id="statistics">
            <h3>Estadísticas Generadas</h3>
            <canvas id="barChart"></canvas>
            <canvas id="pieChart"></canvas>
        </div>
    </section>

    <script>
        const API_KEY = 'cfd2eebb13ae7c9ab9898b21'; // Clave API proporcionada

        document.addEventListener("DOMContentLoaded", async () => {
            await loadDollarValues();
        });

        async function loadDollarValues() {
            const today = new Date();
            let tbody = '';
            for (let i = 0; i < 50; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const formattedDate = date.toISOString().split('T')[0];
                const pesoValue = await getExchangeRate(date, 'COP');
                tbody += `
                    <tr>
                        <td>${formattedDate}</td>
                        <td>${pesoValue}</td>
                        <td>1</td>
                    </tr>
                `;
            }
            document.querySelector('#dollar-values tbody').innerHTML = tbody;
        }

        async function getExchangeRate(date, currency) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1);
            const day = String(date.getDate());
            const response =
                await fetch(`'https://api.exchangerate-api.com/v4/latest/USD`);
            /*    await fetch(`https://v6.exchangerate-api.com/v6/${API_KEY}/history/USD/${year}/${month}/${day}`); */
            const data = await response.json();
            return data.rates[currency].toFixed(2);
        }

        async function generateStatistics() {
            const months = document.getElementById('months').value;
            const today = new Date();
            const values = [];
            const labels = [];
            for (let i = 0; i < months; i++) {
                const startOfMonth = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const endOfMonth = new Date(today.getFullYear(), today.getMonth() - i + 1, 0);
                labels.push(`${startOfMonth.toISOString().split('T')[0]} a ${endOfMonth.toISOString().split('T')[0]}`);

                const pesoValue = await getMonthlyAverage(startOfMonth, endOfMonth, 'COP');
                values.push(pesoValue);
            }

            const barCtx = document.getElementById('barChart').getContext('2d');
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valores Promedio del Dólar en Pesos Colombianos',
                        data: values,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                }
            });

            const pieCtx = document.getElementById('pieChart').getContext('2d');
            new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Distribución de Valores',
                        data: values,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                }
            });
        }

        async function getMonthlyAverage(startDate, endDate, currency) {
            let total = 0;
            let count = 0;
            const date = new Date(startDate);
            while (date <= endDate) {
                const pesoValue = await getExchangeRate(date, currency);
                total += parseFloat(pesoValue);
                count++;
                date.setDate(date.getDate() + 1);
            }
            return (total / count).toFixed(2);
        }
    </script>
</body>
</html>